name: Deploy to GitHub Pages (gh-pages branch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "gh-pages-deploy"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Force clean install all dependencies
        run: |
          echo "ğŸ§¹ Cleaning previous installations..."
          rm -rf node_modules package-lock.json .nuxt .output
          echo "ğŸ“¦ Installing dependencies from scratch..."
          npm install --force
          echo "ğŸ” Verifying critical dependencies..."
          npm list @nuxtjs/tailwindcss || npm install @nuxtjs/tailwindcss@latest
          npm list @nuxt/content || npm install @nuxt/content@latest
          npm list @nuxt/icon || npm install @nuxt/icon@latest
          npm list @nuxtjs/seo || npm install @nuxtjs/seo@latest
          npm list @nuxtjs/sitemap || npm install @nuxtjs/sitemap@latest
          npm list tailwindcss || npm install tailwindcss@latest
          npm list autoprefixer || npm install autoprefixer@latest
          npm list cssnano || npm install cssnano@latest

      - name: Verify Nuxt preparation
        run: |
          echo "ğŸ”§ Preparing Nuxt..."
          npm run postinstall
          echo "âœ… Nuxt preparation complete"

      - name: Generate static site
        run: |
          echo "ğŸš€ Generating static site..."
          npm run generate
        env:
          NODE_ENV: production
          NUXT_SITE_URL: https://abdulbarry.me
          NUXT_SITE_NAME: "Abdulbarry Portfolio"
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NUXT_FORMSPREE_ENDPOINT: ${{ secrets.NUXT_FORMSPREE_ENDPOINT }}

      - name: Verify build output
        run: |
          echo "ğŸ” Verifying build output..."
          ls -la .output/public/
          echo "ğŸ“Š Build size:"
          du -sh .output/public/
          echo "âœ… Build verification complete"

      - name: Add CNAME file for custom domain
        run: |
          echo "ğŸŒ Adding CNAME file..."
          echo "abdulbarry.me" > .output/public/CNAME
          echo "âœ… CNAME file added"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .output/public
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          cname: abdulbarry.me

      - name: Deployment success notification
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Your site should be available at: https://abdulbarry.me"
          echo "â° DNS propagation may take up to 24 hours for first-time setup"